---
title: "Comparing communities in isotope-space"
author: "Andrew L Jackson"
date: "21 July 2015"
output: html_document
---

Let us return to the original figure we explored in [Introduction-to-SIBER](Introduction-to-SIBER.html) where we had two communities side-by-side, and we wanted to ask whether they differed in how the individuals and populations within were distributed in isotope-space.


```{r, echo=FALSE, message = FALSE, fig.width = 10, fig.height = 4}

library(siar, quietly = TRUE,
        verbose = FALSE,
        logical.return = FALSE)


par(mfrow=c(1,3))

source("plot.siber.data.r")

M <- plot.siber.data("../siber-scripts/example_layman_data.csv",
                tt = "Community 1", 
                xlim=c(-10, 15), 
                ylim=c(-5, 15))
M <- plot.siber.data("../siber-scripts/example_layman_data_2.csv",
                tt = "Community 2",
                xlim=c(-10, 15), 
                ylim=c(-5, 15))


# create a blank plot to house the legend
plot(0, type = "n", bty = "n", xaxt = "n", yaxt = "n",
     xlab = "", ylab = "")
legend("center",
       legend = as.character(c(paste("Group ",1:M),
                               "Convex hull \n through means")),
       pch = c(rep(1,M),NA),
       col=c(1:M,1,1),
       lty = c(rep(NA,M),1),
       bty="n",
       cex = 1.4)

```

With a convex hull drawn between the means of the populations that make up the communities, it certainly appears that __Community 2__ occupies a larger portion of isotope-space than __Community 1__. Just as is the case when fitting ellipses to the popuations within a community, there is uncertainty involved in estimating the means that describe their centroid (centre of mass). We can exploit this uncertainty to calculate a range of convex hulls that have a robust probabalistic interpretation within the Bayesian framework we use to esimate the means of the data. More than just convex hulls, we can calculate all 6 of the metrics proposed in [Layman et al 2007](https://scholar.google.com/citations?view_op=view_citation&hl=en&user=6yV_oeoAAAAJ&citation_for_view=6yV_oeoAAAAJ:u-x6o8ySG0sC). 

* __TA__ - the area of convex hull containing, in the case of SIBER, the means of the populations that comprise the community.
* __dN_range__ - the distance in units between the min and max y-axis populations means which is most often d15Nitrogen in ecological studies.
* __dC_range__ - the distance in units between the min and max x-axis population means which is most often d13Carbon in ecological studies.
* __CD__ - the mean distance to centroid from the means
* __MNND__ - the mean nearest neighbour distance of the means
* __SDNND__ - the standard deviation of the nearest neighbour distance

Estimating these metrics is straight forward in SIAR, although currently you will need to load each dataset separately, and fit separate models, and compare the outputs in a pairwise fashion, using much the same code as we used to compare ellipses among populations.

```{r, echo=FALSE, message = FALSE,}
# read in some data
comm1 <- read.csv("../siber-scripts/example_layman_data.csv", header=T)

comm2 <- read.csv("../siber-scripts/example_layman_data_2.csv", header=T)

# calculate the Bayesian Layman metrics given data for Isotopes 1 and 2, 
# a grouping variable Group and a number of iterations to use to generate
# the results
metrics.comm1 <- siber.hull.metrics(comm1$x, comm1$y, comm1$group, R=10^4)

metrics.comm2 <- siber.hull.metrics(comm2$x, comm2$y, comm2$group, R=10^4)

```

We can then plot out the estimated posterior distribution for each of the metrics. One of the difficulties in putting all of them on the same figure is that the convex hull (TA) tends to be much larger in magnitude (it is in units squared after all) and so it can distort the presentation of the others. I tend to plot it separately to the other metrics, at least for a first attempt.

```{r, fig.width = 6, fig.height = 6}

# ------------------------------------------------------------------------------
# Plot out the results
# ------------------------------------------------------------------------------

# these are the names of each of the metrics taken from the fitted model
xlabels <- attributes(metrics.comm1)$dimnames[[2]]

# in this example, I plot TA as a histogram seperately to the other
# metrics as it is usually on a scale so vastly different from the other 
# metrics. TA is third column entry in the output from above.
#dev.new()
par(mfrow = c(1,1))

# use cbind() to put the TA from community 1 and 2 together for plotting side
# by side.
siardensityplot(cbind(metrics.comm1[,3], metrics.comm2[,3]),
                xlab = "Community", 
                ylab = expression('TA  \u2030'^2), 
                bty = "L")

```

```{r, fig.width = 10, fig.height = 6}

# ------------------
# and now the other 5 metrics, here in two panels. But we could reorder them
# manually as we did above with TA.
par(mfrow = c(1,2))

siardensityplot(metrics.comm1[,c(1,2,4,5,6)],
                xticklabels = xlabels[c(1,2,4,5,6)],
                ylims = c(0,25),
                ylab = expression('\u2030'),
                xlab = "Metric",
                main = "Community 1",
                bty = "L")

siardensityplot(metrics.comm2[,c(1,2,4,5,6)],
                xticklabels = xlabels[c(1,2,4,5,6)],
                ylims = c(0,25),
                ylab = expression('\u2030'),
                xlab = "Metric", 
                main = "Community 2",
                bty = "L")


```


And that pretty is pretty much that for comparing these metrics across communities, except perhaps to make a probabalistic statement about how dNr (for example) differs between __Community 1__ and __Community 2__. In this case, what is the probabily that dNr in Community 1 is less than dNr in Community 2?

```{r}

dNr1.lt.dNr2 <- sum(metrics.comm1[,1] < metrics.comm2[,1]) / length(metrics.comm1[,1])

print(dNr1.lt.dNr2)

```




